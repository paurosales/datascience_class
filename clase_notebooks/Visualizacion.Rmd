---
title: "Visualizacion de datos"
author: "Eli Sulvarán Guel"
date: "<small>`r Sys.Date()`</small>"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: true
    cod_folding: hide
    center: true
    theme: sandstone
---

# Llamar librerias y preparar los datos
Llamamos a la libreria requerida para generar las graficas
```{r}
library(ggplot2)
```


Leemos el archivo que vamos a visualizar
```{r}
setwd("/home/paulina/Documents/DataScience/Notebooks/")
hers <- read.csv("source/hersdata.csv")
```


Imprimimos las primeras lineas de los datos para saber que tipo de informacion encontramos 
```{r}
head(hers)
```

# Generacion de graficas de barras y de pie 
Las graficas de barras y de pie funcionan para visualizar comparaciones cuantitativas entre grupos discretos. 
Una de las variables dentro de nuestros datos es physact, que indica que tanto ejercicio hace la paciente. Podemos visualizar cuantas mujeres pertenecen a cada categoria de la siguiente manera
```{r}
counts <- table(hers$physact) #Obtenemos la cuenta para cada categoria con la funcion table()
counts <- as.data.frame(counts) #Lo convertimos en un dataframe para graficar
counts
```
### Grafica de barras
Esta es la forma mas sencilla de realizar una grafica de barras
```{r}
ggplot(counts, aes(x = Var1, y = Freq)) +
  geom_bar(stat = "identity")
```


Para hacer la grafica anterior mas estetica, podemos agregar el parametro "fill", para darle un color distinto a cada barra
```{r}
ggplot(counts, aes(x = Var1, y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") 
```


Como podemos notar, en el eje de las x, las palabras se amontonan, ademas de que tenemos una leyenda, por lo que estan duplicadas. Hay dos formas de solucionar esto:
```{r}
#Girando la grafica con coord_flip() y eliminando la leyenda con theme()
ggplot(counts, aes(x = Var1, y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme(legend.position = "none") 

#Eliminando los nombres del eje de las x y dejando la leyenda
ggplot(counts, aes(x = Var1, y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") +
  theme(axis.ticks.x = element_blank(), axis.text.x=element_blank())
```


Tambien podemos modificar los nombres de los grupos, el titulo y los ejes
```{r}
#Para cambiar el titulo y los nombres de los ejes, usamos los parametros "title", "x" y "y" dentro de labs()
#Paraca cambiar los nombres de los grupos:
#Caso 1: usando "labels" adentro de scale_x_discrete() 
ggplot(counts, aes(x = Var1, y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme(legend.position = "none") +
  scale_x_discrete(labels = c("Algo activa", "Mucho menos activa", "Mucho más activa", "Algo menos activa", "Algo más activa")) +
  labs(title = "Numero de mujeres pertenecientes a cada grupo de \n actividad física", x = "Actividad física", y = "Número de mujeres")

#Caso 2: usando "name" y "labels" adentro de scale_fill_discrete()
ggplot(counts, aes(x = Var1, y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") +
  theme(axis.ticks.x = element_blank(), axis.text.x=element_blank()) +
  scale_fill_discrete(name = "Actividad física", labels = c("Algo activa", "Mucho menos activa", "Mucho más activa", "Algo menos activa", "Algo más activa")) +
  labs(title = "Numero de mujeres pertenecientes a cada grupo de \n actividad física", x = "", y = "Número de mujeres")
```

### Grafica de barras para tres variables: 
Si queremos visualizar una variable adicional, tenemos que realizar un nuevo subset de nuestros datos con la funcion tapply
```{r}
#Sacamos las cuentas de mujeres para cada grupo de actividad fisica y de diabetes
counts2 <- tapply(hers$physact, 
                  list(hers$physact, hers$diabetes), 
                  table)
#Convertimos la matriz en un dataframe y hacemos que los nombres de las filas sean una columna
counts2 <- as.data.frame(counts2)
counts2$Physact <- rownames(counts2)
counts2
```


Como podemos notar, la tabla se encuentra en formato "wide" y necesitamos formato "long". Para ello, transformamos el dataframe con reshape()
```{r}
counts2 <- reshape(counts2, #Objeto a transformar
        direction = "long", #Necesitamos formato long
        varying = list(names(counts2)[1:2]), #Las columnas a alargar (las que tienen las cuentas) son la 1 y la 2
        v.names = "Counts", #Las cuentas se almacenaran en la columna "Counts"
        idvar = "Physact", #La variable con los identificadores del grupo de actividad fisica
        timevar = "Diabetes", #Variable que vamos a alargar, que corresponde a las columnas "no" y "yes"
        times = c("no", "yes"))
row.names(counts2) <- NULL
counts2
```


Con los datos de esta forma, ya podemos graficar. Para añadir la nueva variable, vamos a colocar el nombre de la misma en el parametro "fill"
```{r}
ggplot(counts2, aes(x = Physact, y = Counts, fill = Diabetes)) +
  geom_bar(stat = "identity") 
```


Tambien podemos hacer graficas de barra con grupos pero sin apilar, y colocando las barras lado a lado, añadiendo el parametro "position" en geom_bar()
```{r}
ggplot(counts2, aes(x = Physact, y = Counts, fill = Diabetes)) +
  geom_bar(stat = "identity", position=position_dodge()) 
```


Finalmente, podemos modificar todo el texto y girar la gráfica para obtener un mejor resultado
```{r}
#Barras apiladas
ggplot(counts2, aes(x = Physact, y = Counts, fill = Diabetes)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_discrete(name = "Diabetes", labels = c("No", "Sí")) +
  scale_x_discrete(labels = c("Algo activa", "Mucho menos activa", "Mucho más activa", "Algo menos activa", "Algo más activa")) +
  labs(title = "Numero de mujeres pertenecientes a cada grupo de \n actividad física", x = "Actividad física", y = "Número de mujeres")

#Barras lado a lado
ggplot(counts2, aes(x = Physact, y = Counts, fill = Diabetes)) +
  geom_bar(stat = "identity", position=position_dodge()) +
  coord_flip() +
  scale_fill_discrete(name = "Diabetes", labels = c("No", "Sí")) +
  scale_x_discrete(labels = c("Algo activa", "Mucho menos activa", "Mucho más activa", "Algo menos activa", "Algo más activa")) +
  labs(title = "Numero de mujeres pertenecientes a cada grupo de \n actividad física", x = "Actividad física", y = "Número de mujeres")
```


### Grafica de pie
Regresemos al primer subset de datos, que unicamente incluye la variable physact. ggplot2 no tiene una funcion para realizar una grafica de pie, pero pueden hacerse agregando coord_polar() a la grafica de barras. La forma mas sencilla de realizar una grafica de pie es la siguiente: 
```{r}
ggplot(counts, aes(x = "", y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") +
  coord_polar("y", start = 0) 
```


La grafica anterior no es tan estetica debido a los numeros, el círculo blanco y la raya encontrada en el borde del lado izquierdo. Todo esto se puede eliminar con theme()
```{r}
ggplot(counts, aes(x = "", y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") +
  coord_polar("y", start = 0) +
  theme(axis.text = element_blank(), #Elimina los numeros
        axis.ticks = element_blank(), #Elimina la raya
        panel.grid  = element_blank()) #Elimina el circulo blanco
```


Esta grafica se ve mucho mejor. Finalmente, podemos cambiar los nombres de los ejes y de la leyenda. 
```{r}
ggplot(counts, aes(x = "", y = Freq, fill = Var1)) +
  geom_bar(stat = "identity") +
  coord_polar("y", start = 0) +
  theme(axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        panel.grid  = element_blank()) +
  scale_fill_discrete(name = "Actividad física", labels = c("Algo activa", "Mucho menos activa", "Mucho más activa", "Algo menos activa", "Algo más activa")) +
  labs(title = "Numero de mujeres pertenecientes a cada grupo de \n actividad física", x = "", y = "")
```

Aunque las graficas de barras y de pie funcionan para lo mismo, lo mas recomendable siempre es usar graficas de barra, pues a veces los humanos no podemos distinguir correctamente entre angulos similares. [En este post lo explican bastante bien.](https://www.data-to-viz.com/caveat/pie.html)


# Generacion de graficas de densidad e histogramas
Este tipo de graficas funcionan cuando queremos observar la distribucion de variables cuantitativas

### Histograma para una variable
Esta es la forma mas basica de crear un histograma
```{r}
ggplot(hers, aes(x = glucose)) + 
  geom_histogram() +
  labs(title = "Histograma de la glucosa", x = "Glucosa", y = "Recuento")
```


Podemos hacer la grafica mas bonita modificando algunos parametros, como el color del contorno y el relleno y el grosor de las barras, utilizando los argumentos "binwidth", "color" y "fill"
```{r}
ggplot(hers, aes(x = glucose)) + 
  geom_histogram(binwidth = 2, color = "black", fill = "white") +
  labs(title = "Histograma de la glucosa", x = "Glucosa", y = "Recuento")
```


Con esta grafica, podemos observar que la mayoria de las participantes en el estudio presentan valores de glucosa en sangre normales (~100 mg/dL)

### Grafica de densidad
Tambien podemos sobreponer una grafica de densidad en el histograma. El parametro alpha nos permite que la grafica de densidad tenga transaparencia y tambien puedan observarse las barras debajo
```{r}
ggplot(hers, aes(x = glucose)) + 
  geom_histogram(aes(y=..density..), binwidth = 2, color = "black", fill = "white") +
  geom_density(alpha = 0.2, fill = "blue") + 
  labs(title = "Histograma de la glucosa", x = "Glucosa", y = "Recuento")
```

### Histograma para dos variables
Finalmente, podemos agrupar estos datos de acuerdo a alguna variable cualitativa, por ejemplo, si la paciente tiene diabetes, cambiando el parametro "color"
```{r}
ggplot(hers, aes(x = glucose, color = diabetes)) + 
  geom_histogram(binwidth = 2.5) +
  labs(title = "Histograma de la glucosa", x = "Glucosa", y = "Recuento")
```


Al agrupar los datos en mujeres diabeticas y no diabeticas, como era de esperarse, podemos observar que las mujeres diabeticas presentan valores de glucosa en sangre mas elevados que las mujeres no diabeticas.


Como ultimas modificaciones, para hacer nuestra grafica mas estetica, podemos cambiar la leyenda utilizando scale_color_discrete(). 
```{r}
ggplot(hers, aes(x = glucose, color = diabetes)) + 
  geom_histogram(binwidth = 2.5) +
  labs(title = "Histograma de la glucosa", x = "Glucosa", y = "Recuento") + 
  scale_color_discrete(name = "Diabetes", labels = c("No", "Sí")) 
```


# Generacion de graficas de dispersion
Este tipo de graficas funcionan muy bien cuando queremos visualizar dos o mas variables al mismo tiempo, y como se relacionan entre ellas. 

### Grafica de dispersion para dos variables
Forma mas sencilla de realizar graficas de dispersion
```{r}
ggplot(hers, aes(x = weight, y = glucose)) +
  geom_point() +
  labs(title = "Grafica de dispersion entre peso y glucosa", x = "Peso", y = "Glucosa")
```


Con esta grafica, podemos observar que existe una ligera relacion entre el peso y los valores de glucosa. Para confirmar esto, podemos tambien graficar una linea de regresion con geom_smooth()

```{r}
ggplot(hers, aes(x = weight, y = glucose)) +
  geom_point() +
  geom_smooth(method = lm) +
  labs(title = "Grafica de dispersion entre peso y glucosa", x = "Peso", y = "Glucosa")
```


Finalmente, podemos cambiar el color, la forma y la transparencia de los puntos con los parametros "color", "shape" y "alpha"
```{r}
ggplot(hers, aes(x = weight, y = glucose)) +
  geom_point(color = "#39B600", shape = 23, alpha = 0.5) +
  labs(title = "Grafica de dispersion entre peso y glucosa", x = "Peso", y = "Glucosa")
```

### Grafica de dispersion para mas de dos variables
Podemos realizar esta misma grafica incluyendo mas variables, y cambiando el color y la forma de los puntos, modificando los parametros "color" y "shape"
```{r}
ggplot(hers, aes(x = weight, y = glucose, color = diabetes)) +
  geom_point(aes(shape = insulin)) +
  labs(title = "Grafica de dispersion entre peso y glucosa", x = "Peso", y = "Glucosa")
```

Nuevamente, como era de esperarse, las mujeres diabeticas son quienes presentan valores de glucosa mas elevados, lo cual podemos observar por la agrupacion de los puntos azules hacia arriba y de los puntos rojos hacia abajo. Del mismo modo, muchos de los puntos azules tienen forma triangular, indicando que estan bajo tratamiento de insulina, y todos los puntos naranjas tienen forma circular. 


De nuevo, podemos modificar la leyenda utilizando scale_color_discrete() y scale_shape_discrete().
```{r}
ggplot(hers, aes(x = weight, y = glucose, color = diabetes)) +
  geom_point(aes(shape = insulin)) +
  labs(title = "Grafica de dispersion entre peso y glucosa", x = "Peso", y = "Glucosa") + 
  scale_color_discrete(name = "Diabetes", labels = c("No", "Sí")) +
  scale_shape_discrete(name = "Insulina", labels = c("No", "Sí")) 
```

# Generacion de boxplots
Estas graficas funcionan cuando queremos visualizar diferencias entre valores de una variable cuantitativa para los grupos de una variable cualitativa. 

### Boxplots para dos variables 
Forma mas sencilla de realizar un boxplot
```{r}
ggplot(hers, aes(x = exercise, y = BMI)) + 
  geom_boxplot() +
  labs(title = "Boxplot del Indice de Masa Corporal y el ejercicio", x = "Ejercicio", y = "Indice de Masa Corporal (IMC)")
```


Los boxplots son una herramienta muy util porque nos dan informacion sobre las medidas de tendencia central de nuestros datos. Lo que se encuentra dentro de la caja corresponde al 50% de nuestros datos, que van desde el primer cuartil (el 25% de nuestros datos) hasta el tercer cuartil (el 75% de nuestros datos). La linea de en medio dentro de la caja corresponde a la mediana de nuestros datos, o bien, al segundo cuartil. Finalmente, los puntos que sobresalen de las lineas son los outliers o valores atipicos de nuestros datos. En este caso, podemos observar que en general, el IMC es menor en mujeres que realizan ejercicio que en mujeres que no lo realizan. 



Nuevamente, podemos hacer nuestras graficas mas esteticas cambiando el color, utilizando el parametro "color". Tambien podemos quitar la leyenda, pues en este caso no la necesitamos, utilizando el parametro "legend.position = "none"" dentro de theme. 
```{r}
ggplot(hers, aes(x = exercise, y = BMI, color = exercise)) + 
  geom_boxplot() + 
  labs(title = "Boxplot del Indice de Masa Corporal y el ejercicio", x = "Ejercicio", y = "Indice de Masa Corporal")

ggplot(hers, aes(x = exercise, y = BMI, color = exercise)) + 
  geom_boxplot() + 
  theme(legend.position = "none") +
  labs(title = "Boxplot del Indice de Masa Corporal y el ejercicio", x = "Ejercicio", y = "Indice de Masa Corporal")
```

### Boxplots para tres variables
Finalmente, podemos visualizar otra variable mas para observar grupos, cambiando el parametro "color" y asignandole una variable
```{r}
ggplot(hers, aes(x = exercise, y = BMI, color = smoking)) + 
  geom_boxplot() + 
  labs(title = "Boxplot del Indice de Masa Corporal y el ejercicio", x = "Ejercicio", y = "Indice de Masa Corporal")
```


Curiosamente, podemos observar que tanto para el grupo de mujeres que hacen ejercicio, como para el grupo de mujeres que no lo hacen, las mujeres fumadoras tienen un menor indice de masa corporal. 


Modificaciones adicionales para hacer la grafica mas estetica, cambiando los valores del eje x con scale_x_discrete() y la leyenda con scale_color_discrete()...
```{r}
ggplot(hers, aes(x = exercise, y = BMI, color = smoking)) + 
  geom_boxplot() + 
  labs(title = "Boxplot del Indice de Masa Corporal y el ejercicio", x = "Ejercicio", y = "Indice de Masa Corporal") + 
  scale_color_discrete(name = "Fuma", labels = c("No", "Sí")) + 
  scale_x_discrete(labels = c("No", "Sí"))
```


# Generacion de heatmaps
Los heatmaps funcionan para visualizar datos encontrados en una matriz. Son muy utiles para graficas de correlacion, pero eso lo veremos mas adelante. Por el momento, vamos a visualizar datos cuantitativos de nuestro objeto. 

```{r}
#Seleccionamos algunas variables cuantitativas: edad, peso, medida de la cintura, glucosa, colesterol LDL, colesterol HDL, trigliceridos, tensión arterial sistolica y tensión arterial diastolica
hm_data <- aggregate(hers[,c(2, 15, 17, 19, 21, 22, 23, 24, 25)], 
          by = list(hers$physact), #Agrupamos por actividad fisica
          mean, na.rm = T) #Obtenemos la media 
hm_data
```

De nuevo, tenemos que transformar estos datos a formato long. 
```{r}
hm_data <- reshape(hm_data, 
                   direction = "long", 
                   varying = list(names(hm_data)[2:10]),
                   v.names = "Value", 
                   idvar = "Group.1", 
                   timevar = "Variable", 
                   times = colnames(hm_data)[2:10])
row.names(hm_data) <- NULL
hm_data[1:15,]
```

Esta es la forma mas sencilla de realizar un heatmap
```{r}
ggplot(hm_data, aes(x = Variable, y = Group.1, fill = Value)) +
  geom_tile()
```


Podemos cambiar las paletas usando scale_fill_gradient() y scale_fill_gradient2()
```{r}
ggplot(hm_data, aes(x = Variable, y = Group.1, fill = Value)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "steelblue")

ggplot(hm_data, aes(x = Variable, y = Group.1, fill = Value)) +
  geom_tile() +
  scale_fill_gradient2(low = "forestgreen", high = "red", mid = "gold", midpoint = median(hm_data$Value))
```


Por ultimo, podemos modificar los nombres de las variables. 
```{r}
ggplot(hm_data, aes(x = Variable, y = Group.1, fill = Value)) +
  geom_tile() +
  scale_fill_gradient2(low = "forestgreen", high = "red", mid = "gold", midpoint = median(hm_data$Value)) +
  labs(title = "Heatmap de variables por grupo de actividad física", fill = "Valor", y = "Grupo de actividad física", x = "Variable") +
  scale_y_discrete(labels = c("Algo activa", "Mucho menos activa", "Mucho más activa", "Algo menos activa", "Algo más activa")) +
  scale_x_discrete(labels = c("Edad", "TAD", "Glucosa", "HDL", "LDL", "TAS", "TG", "Cintura", "Peso"))
```




















